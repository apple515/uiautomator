package com.gld.base;

import java.io.BufferedReader;
import java.io.BufferedWriter;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.FileWriter;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.OutputStreamWriter;

public class UiAutomatorHelper {

	// ä»¥ä¸‹å‚æ•°éœ?è¦é…ç½®ï¼Œç”¨ä¾‹é›†idï¼Œç”¨ä¾‹idï¼Œå®‰å“id
	private static String android_id = "1";
	private static String jar_name = "demo1";
	private static String test_class = "test.Demo"; // åŒ…å.ç±»å(ç±»æ˜¯å“ªä¸ªè¦è¿è¡Œçš„ç±»åå°±æ˜¯åªæ”¾æ–¹æ³•çš„é‚£ä¸?)
	private static String test_name = "test";

	// å·¥ä½œç©ºé—´ä¸éœ€è¦é…ç½®ï¼Œè‡ªåŠ¨è·å–å·¥ä½œç©ºé—´ç›®å½•
	private static String workspace_path;

	public static void main(String[] args) {
		String jarName="", testClass="", testName="", androidId="";
		for (int i = 0; i < args.length; i++) {
			if(args[i].equals("--jar_name")){jarName=args[i+1];}
			if(args[i].equals("--test_class")){testClass=args[i+1];}
			if(args[i].equals("--test_name")){testName=args[i+1];}
			if(args[i].equals("--android_id")){androidId=args[i+1];}
		}
		new UiAutomatorHelper(jarName, testClass, testName, androidId);

	}

	public UiAutomatorHelper() {
		workspace_path = getWorkSpase();
		System.out.println("---å·¥ä½œç©ºé—´ï¼š\t\n" + getWorkSpase());
	}

	/**
	 * éœ?æ±‚ï¼šUIå·¥ç¨‹è°ƒè¯•æ„é? å™¨ï¼Œè¾“å…¥jaråŒ…åï¼ŒåŒ…åï¼Œç±»åï¼Œç”¨ä¾‹å
	 * 
	 * @param jarName
	 * @param testClass
	 * @param testName
	 * @param androidId
	 */
	public UiAutomatorHelper(String jarName, String testClass, String testName, String androidId) {
		System.out.println("-----------start--uiautomator--debug-------------");
		workspace_path = getWorkSpase();
		System.out.println("----å·¥ä½œç©ºé—´ï¼š\t\n" + getWorkSpase());

		jar_name = jarName;
		test_class = testClass;
		test_name = testName;
		android_id = androidId;
		runUiautomator();
		System.out.println("*******************");
		System.out.println("---FINISH DEBUG----");
		System.out.println("*******************");
	}

	/**
	 * éœ?æ±‚ï¼šbuild å’? å¤åˆ¶jaråˆ°æŒ‡å®šç›®å½?
	 * 
	 * @param jarName
	 * @param testClass
	 * @param testName
	 * @param androidId
	 * @param isRun
	 */
	public UiAutomatorHelper(String jarName, String testClass, String testName, String androidId,
			String ctsTestCasePath) {
		System.out.println("-----------start--uiautomator--debug-------------");
		workspace_path = getWorkSpase();
		System.out.println("----å·¥ä½œç©ºé—´ï¼š\t\n" + getWorkSpase());

		jar_name = jarName;
		test_class = testClass;
		test_name = testName;
		android_id = androidId;
		buildUiautomator(ctsTestCasePath);

		System.out.println("*******************");
		System.out.println("---FINISH DEBUG----");
		System.out.println("*******************");

	}

	// è¿è¡Œæ­¥éª¤
	private void runUiautomator() {
		creatBuildXml();
		modfileBuild();
		buildWithAnt();
		if (System.getProperty("os.name").equals("Linux")) {
			pushTestJar(workspace_path + "/bin/" + jar_name + ".jar");
		} else {
			pushTestJar(workspace_path + "\\bin\\" + jar_name + ".jar");
		}

		if (test_name.equals("")) {
			runTest(jar_name, test_class);
			return;
		}
		runTest(jar_name, test_class + "#" + test_name);
	}

	// 1--åˆ¤æ–­æ˜¯å¦æœ‰build
	public boolean isBuild() {
		File buildFile = new File("build.xml");
		if (buildFile.exists()) {
			return true;
		}
		// åˆ›å»ºbuild.xml
		execCmd("cmd /c android create uitest-project -n " + jar_name + " -t " + android_id + " -p " + workspace_path);
		return false;
	}

	// åˆ›å»ºbuild.xml
	public void creatBuildXml() {
		execCmd("cmd /c android create uitest-project -n " + jar_name + " -t " + android_id + " -p " + "\""
				+ workspace_path + "\"");
	}

	// 2---ä¿®æ”¹build
	public void modfileBuild() {
		StringBuffer stringBuffer = new StringBuffer();
		try {
			File file = new File("build.xml");
			if (file.isFile() && file.exists()) { // åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨
				InputStreamReader read = new InputStreamReader(new FileInputStream(file));
				BufferedReader bufferedReader = new BufferedReader(read);
				String lineTxt = null;
				while ((lineTxt = bufferedReader.readLine()) != null) {
					if (lineTxt.matches(".*help.*")) {
						lineTxt = lineTxt.replaceAll("help", "build");
						// System.out.println("ä¿®æ”¹åï¼š " + lineTxt);
					}
					stringBuffer = stringBuffer.append(lineTxt + "\t\n");
				}
				read.close();
			} else {
				System.out.println("æ‰¾ä¸åˆ°æŒ‡å®šçš„æ–‡ä»¶");
			}
		} catch (Exception e) {
			System.out.println("è¯»å–æ–‡ä»¶å†…å®¹å‡ºé”™");
			e.printStackTrace();
		}

		System.out.println("-----------------------");

		// ä¿®æ”¹åå†™å›å»
		writerText("build.xml", new String(stringBuffer));
		System.out.println("--------ä¿®æ”¹buildå®Œæˆ---------");
	}

	// 3---ant æ‰§è¡Œbuild
	public void buildWithAnt() {
		if (System.getProperty("os.name").equals("Linux")) {
			execCmd("ant");
			return;
		}
		execCmd("cmd /c ant");
	}

	// 4---push jar
	public void pushTestJar(String localPath) {
		localPath = "\"" + localPath + "\"";
		System.out.println("----jaråŒ…è·¯å¾„ï¼š " + localPath);
		String pushCmd = "adb push " + localPath + " /data/local/tmp/";
		System.out.println("----" + pushCmd);
		execCmd(pushCmd);
	}

	// è¿è¡Œæµ‹è¯•
	public void runTest(String jarName, String testName) {
		String runCmd = "adb shell uiautomator runtest ";
		String testCmd = jarName + ".jar " + "--nohup -c " + testName;
		System.out.println("----runTest:  " + runCmd + testCmd);
		execCmd(runCmd + testCmd);
	}

	public String getWorkSpase() {
		File directory = new File("");
		String abPath = directory.getAbsolutePath();
		return abPath;
	}

	/**
	 * éœ?æ±‚ï¼šæ‰§è¡Œcmdå‘½ä»¤ï¼Œä¸”è¾“å‡ºä¿¡æ¯åˆ°æ§åˆ¶å°
	 * 
	 * @param cmd
	 */
	public void execCmd(String cmd) {
		System.out.println("----execCmd:  " + cmd);
		try {
			Process p = Runtime.getRuntime().exec(cmd);
			// æ­£ç¡®è¾“å‡ºæµ?
			InputStream input = p.getInputStream();
			BufferedReader reader = new BufferedReader(new InputStreamReader(input));
			String line = "";
			while ((line = reader.readLine()) != null) {
				System.out.println(line);
				saveToFile(line, "runlog.log", false);
			}
			// é”™è¯¯è¾“å‡ºæµ?
			InputStream errorInput = p.getErrorStream();
			BufferedReader errorReader = new BufferedReader(new InputStreamReader(errorInput));
			String eline = "";
			while ((eline = errorReader.readLine()) != null) {
				System.out.println(eline);
				saveToFile(eline, "runlog.log", false);
			}
		} catch (IOException e) {
			e.printStackTrace();
		}
	}

	/**
	 * éœ?æ±‚ï¼šå†™å¦‚å†…å®¹åˆ°æŒ‡å®šçš„æ–‡ä»¶ä¸?
	 * 
	 * @param path
	 *            æ–‡ä»¶çš„è·¯å¾?
	 * @param content
	 *            å†™å…¥æ–‡ä»¶çš„å†…å®?
	 */
	public void writerText(String path, String content) {

		File dirFile = new File(path);

		if (!dirFile.exists()) {
			dirFile.mkdir();
		}

		try {
			// new FileWriter(path + "t.txt", true) è¿™é‡ŒåŠ å…¥true å¯ä»¥ä¸è¦†ç›–åŸæœ‰TXTæ–‡ä»¶å†…å®¹ ç»­å†™
			BufferedWriter bw1 = new BufferedWriter(new FileWriter(path));
			bw1.write(content);
			bw1.flush();
			bw1.close();
		} catch (IOException e) {
			e.printStackTrace();
		}
	}

	public void saveToFile(String text, String path, boolean isClose) {
		File file = new File("runlog.log");
		BufferedWriter bf = null;
		try {
			FileOutputStream outputStream = new FileOutputStream(file, true);
			OutputStreamWriter outWriter = new OutputStreamWriter(outputStream);
			bf = new BufferedWriter(outWriter);
			bf.append(text);
			bf.newLine();
			bf.flush();

			if (isClose) {
				bf.close();
			}
		} catch (FileNotFoundException e1) {
			e1.printStackTrace();
		} catch (IOException e) {
			e.printStackTrace();
		}

	}

	/**
	 * éœ?æ±‚ï¼šç¼–è¯‘å’Œå¤åˆ¶jaråŒ…æŒ‡å®šæ–‡ä»?
	 * 
	 * @param newPath
	 */
	private void buildUiautomator(String newPath) {
		creatBuildXml();
		modfileBuild();
		buildWithAnt();
		// å¤åˆ¶æ–‡ä»¶åˆ°æŒ‡å®šæ–‡ä»¶å¤¹
		copyFile(workspace_path + "\\bin\\" + jar_name + ".jar", newPath);

	}

	/**
	 * å¤åˆ¶å•ä¸ªæ–‡ä»¶
	 * 
	 * @param oldPath
	 *            String åŸæ–‡ä»¶è·¯å¾? å¦‚ï¼šc:/fqf.txt
	 * @param newPath
	 *            String å¤åˆ¶åè·¯å¾? å¦‚ï¼šf:/fqf.txt
	 * @return boolean
	 */
	public void copyFile(String oldPath, String newPath) {
		System.out.println("æºæ–‡ä»¶è·¯å¾„ï¼š" + oldPath);
		System.out.println("ç›®æ ‡æ–‡ä»¶è·¯å¾„ï¼?" + newPath);
		try {
			int bytesum = 0;
			int byteread = 0;
			File oldfile = new File(oldPath);
			if (oldfile.exists()) { // æ–‡ä»¶å­˜åœ¨æ—?
				InputStream inStream = new FileInputStream(oldPath); // è¯»å…¥åŸæ–‡ä»?
				@SuppressWarnings("resource")
				FileOutputStream fs = new FileOutputStream(newPath);
				byte[] buffer = new byte[1444];
				@SuppressWarnings("unused")
				int length;
				while ((byteread = inStream.read(buffer)) != -1) {
					bytesum += byteread; // å­—èŠ‚æ•? æ–‡ä»¶å¤§å°
					System.out.println(bytesum);
					fs.write(buffer, 0, byteread);
				}
				inStream.close();
			}
		} catch (Exception e) {
			System.out.println("å¤åˆ¶å•ä¸ªæ–‡ä»¶æ“ä½œå‡ºé”™");
			e.printStackTrace();

		}

	}

}